---
title: "MSCS 264: Homework #15 Key"
output:
  pdf_document:
    fig_height: 3
    fig_width: 4.5
  word_document: default
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r, message = FALSE, include = FALSE}
library(lubridate)
library(tidyverse)
library(tidytext)
library(wordcloud)

barack <- read_csv("~/Mscs 264 F22/Class/Data/tweets_potus.csv")
michelle <- read_csv("~/Mscs 264 F22/Class/Data/tweets_flotus.csv")
```

President Barack Obama became the first US President with an official twitter account, when @POTUS went live on May 18, 2015. (Yes, there was a time before Twitter.)  First Lady Michelle Obama got in on Twitter much earlier, though [her first tweet](https://youtu.be/3Pze1f1x7yU) was not from @FLOTUS. All of the tweets from @POTUS and @FLOTUS are now archived on Twitter as @POTUS44 and @FLOTUS44, and they are available as a csv download from the National Archive.
Read more here: https://obamawhitehouse.archives.gov/blog/2017/01/05/new-lenses-first-social-media-presidency

The csv files appear in the Class Data folder. 


1. Explain what the code below does (Hint: Use ? to look at the help menu of a function if you're not sure what it does!)

```{r, message = FALSE}
tweets <- bind_rows(barack %>% 
                      mutate(person = "Barack"),
                    michelle %>% 
                      mutate(person = "Michelle")) %>%
  mutate(timestamp = ymd_hms(timestamp))
```

Since Barack and Michelle have the same 10 columns with one row per tweet, we can stack these two tibbles on top of each other to get a single tibble with all their tweets.  We need, however, to add an 11th variable to identify which person sent each tweet.  Finally, we convert `timestamp` into ymd_hms format.


2. For some additional reference, here is a plot of the number of tweets per month from Barack and Michelle. Identify two interesting things from this plot.

```{r}
ggplot(tweets, aes(x = timestamp, fill = person)) +
  geom_histogram(position = "identity", bins = 48, show.legend = FALSE) +
  facet_wrap(~person, ncol = 1)
```

Michelle started earlier and has more twitter volume.  Fall seems like a slower time for both (vacation?).


3. Michelle ended the tweets that she personally wrote "-mo". What proportion of her tweets did she personally write?

```{r}
michelle %>% 
  mutate(from_m =  str_detect(text, "-mo")) %>%
  summarize(prop_from_m = mean(from_m))
```

Just 3.83%.


4. What proportion of tweets for each person were retweets? 

A retweet will start with "RT". For example:

```{r}
tweets$text[7]
```

```{r}
tweets %>%
  mutate(is_retweet = str_detect(text, "^RT")) %>%
  group_by(person) %>%
  summarize(prop_RT = mean(is_retweet))
```

5.3% for Barack and 32.0% for Michelle.


5. For the year 2016, create a pair of bargraphs comparing the proportion of tweets that are RT by day of the week (x axis = day of week, height of bars indicates the proportion of retweets on a specific day) for Barack and Michelle.  [Hints: Use wday from the lubridate package (look at help to see how to print as words rather than numbers).  Also, consider `geom_bar(stat = "identity", show.legend = FALSE)` after you calculate proportions by person and day of the week.].  See HW15_Q5_plot.pdf for an example of the plot you should create.

```{r}
tweets %>% 
  filter(year(timestamp) == 2016) %>%
  mutate(is_retweet = str_detect(text, "^RT"), 
         day_of_week = wday(timestamp, label = TRUE)) %>%
  group_by(person, day_of_week) %>%
  summarize(prop_RT = mean(is_retweet, na.rm = TRUE)) %>%
  ggplot(aes(x = day_of_week, y = prop_RT, fill= person)) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  facet_grid(.~person)
```


Now, what can we do with tidy data? The actual tidy step for tweets is a little more complex. So I'll give you the code here.

Note that `tidy_tweets` now contains 1 line per word (minus stop words) rather than 1 line per tweet as in `tweets`.  `token = "tweets"` still creates 1 line per word, but in the process it preserves usernames, hashtags, URLs, etc. **In (6)-(10) be sure to start with `tidy_tweets`!**

```{r}
remove_reg <- "&amp;|&lt;|&gt;"

tidy_tweets <- tweets %>% 
  filter(!str_detect(text, "^RT")) %>% 
  mutate(text = str_remove_all(text, remove_reg)) %>%
  unnest_tokens(word, text, token = "tweets") %>%
## Note: This filter part is instead of using anti_join to remove stop words
  filter(!word %in% stop_words$word,                          
         !word %in% str_remove_all(stop_words$word, "'"),
         str_detect(word, "[a-z]"))
```

6. Look at the help menu; what does the `token = "tweets"` mean in the unnest_tokens function?

We want a tidy tibble with one word per row.  The "tweets" option has special properties, like preserving usernames, hashtags, and URLs.


7. Using the bing lexicon, make a graph with week on the x-axis and the difference in positive and negative sentiment on the Y axis. You should filter the data to include only 2015 and 2016. Use `facet_grid` to create a 2x2 set of plots for Barack and Michelle in 2015 and 2016.  Remember that you'll need a count for the combination of factors that each bar represents.  See HW15_Q7_plot.pdf for an example of the plot you should create.

```{r}
tweet_sentiment <- tidy_tweets %>%
  mutate(year = year(timestamp), 
         week = week(timestamp)) %>%
  filter(year == 2015 | year == 2016) %>%
  inner_join(get_sentiments("bing")) %>%
  count(person, week, year, sentiment) %>%
  pivot_wider(names_from = sentiment, values_from = n, values_fill = 0) %>% 
  mutate(sentiment = positive - negative)

ggplot(tweet_sentiment, aes(week, sentiment, fill = person)) +
  geom_col(show.legend = FALSE) +
  facet_grid(year~person, scales = "free_x")
```


8. Create a wordcloud for either Barack or Michelle using their top 100 non-stop words.  [Hint: in your R chunk, you might try `{r, message = FALSE, out.height = "100%", out.width = "100%"}` to get the word cloud to print out larger.]

```{r, message = FALSE, out.height = "100%", out.width = "100%"}
tidy_tweets %>%
  filter(person == "Barack") %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 100, scale = c(2, 0.2)))

tidy_tweets %>%
  filter(person == "Michelle") %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 100, scale = c(2, 0.2)))
```

```{r, eval = FALSE}
# looks cooler in html but can't knit as a pdf
df_b <- tidy_tweets %>%
  filter(person == "Barack") %>%
  anti_join(stop_words) %>%
  count(word) %>%
  rename(freq = n) 
wordcloud2(data = df_b, size = 0.25, shape = 'circle', minSize = 5)

df_m <- tidy_tweets %>%
  filter(person == "Michelle") %>%
  anti_join(stop_words) %>%
  count(word) %>%
  rename(freq = n) 
wordcloud2(data = df_m, size = 0.5, shape = 'circle', minSize = 3)
```


9. Create a tf_idf chart comparing Barack and Michelle like the one comparing the 3 books that we did in class. Any surprises here?

```{r}
tweet_tfidf <- tidy_tweets %>%
  count(word, person, sort = TRUE) %>%
  bind_tf_idf(word, person, n)

tweet_tfidf %>%
  group_by(person) %>%
  slice_max(tf_idf, n = 10) %>%
  ungroup %>%
  ggplot(aes(x = fct_reorder(word, tf_idf), y = tf_idf, fill = person)) +
    geom_col(show.legend = FALSE) +
    coord_flip() +
    facet_wrap(~person, scales = "free")
```
 
No big surprises.  Barack seems to focus more on policy issues (climate, guns, cars), while Michelle focuses on social initiatives (girls, education, health).


10. Create a tf_idf chart based on only the hashtags that Michelle and Barack used.

```{r}
hashtag_tfidf <- tidy_tweets %>%
  filter(str_detect(word, "^#"))%>%
  count(word, person, sort = TRUE) %>%
  bind_tf_idf(word, person, n)

hashtag_tfidf %>%
  group_by(person) %>%
  slice_max(tf_idf, n = 10) %>%
  ungroup %>%
  ggplot(aes(x = fct_reorder(word, tf_idf), y = tf_idf, fill = person)) +
    geom_col(show.legend = FALSE) +
    coord_flip() +
    facet_wrap(~person, scales = "free")
```

